import { getDatabaseOptions } from './database-options'
import { ConfigService } from '@webundsoehne/nestjs-util'

export function generateMongooseMigrateConfig (): any {
  const { migration: migrationOptions } = ConfigService.get('database')
  const [plainUrl, { user, pass, ...options }] = getDatabaseOptions()

  let url = plainUrl

  if (user && pass) {
    url = `mongodb://${encodeURIComponent(user)}:${encodeURIComponent(pass)}@${plainUrl.slice(10)}`
  }

  return {
    mongodb: {
      url,
      options
    },
    ...migrationOptions
  }
}

module.exports = generateMongooseMigrateConfig()
